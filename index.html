<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Contesto AI - Puter.js Edition</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://js.puter.com/v2/"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
/* Prima che qualcuno mi flagelli ho voluto tenere tutto in un file perchÃ© non funzionava nulla se dividevo in piÃ¹ parti, 
non sono riuscito a capire bene il motivo ma per ora va bene cosÃ¬, 
se in futuro riesco a sistemare tutto allora magari lo dividerÃ² in piÃ¹ file, 
ma per ora Ã¨ un unico blocco di codice, spero che non dia troppo fastidio :D */
/* Stile generale */
:root {
    --primaryColor: #0061a4;
    --surfaceColor: #fdfbff;
    --outlineColor: #74777f;
}

body { 
    font-family: 'Roboto', sans-serif; 
    background-color: var(--surfaceColor); 
    margin: 0; 
    padding: 0; 
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; 
    min-height: 100vh;
}

/* Animazione titolo "snake wave" 
aggiungo come io abbia rubato tutto da un mio altro 
progetto che copiava a sua volta lo stile di google*/
@keyframes snakeWave {
    0%,100%{transform: translateY(0);}
    50%{transform: translateY(-12px);}
}
.wave-text span { 
    display:inline-block; 
    animation:snakeWave 1.2s infinite ease-in-out; 
}

/* Lista tentativi */
.guess-row { 
    border-radius: 16px; 
    margin-bottom: 8px; 
    padding: 12px 16px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    position: relative; 
    overflow: hidden; 
    background-color: white; 
    border: 1px solid rgba(0,0,0,0.05); 
}
.progress-bg { 
    position: absolute; 
    left: 0; 
    top: 0; 
    bottom: 0; 
    z-index: 0; 
    transition: width 1s ease; 
}
.content-z { 
    position: relative; 
    z-index: 1; 
    display: flex; 
    justify-content: space-between; 
    width: 100%; 
}

/* Input e pulsante */
.input-rounded { 
    border-radius: 100px; 
    border: 2px solid var(--outlineColor); 
    padding: 16px 24px; 
    outline: none; 
    width: 100%; 
}
.btn-main { 
    border-radius: 20px; 
    padding: 16px; 
    background-color: var(--primaryColor); 
    color: white; 
    min-width: 56px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
}

/* AI Panel */
.ai-panel { 
    background-color: #e1e2ec; 
    border-radius: 24px; 
    padding: 20px; 
    margin-top: 20px; 
    display: none; 
}
.ai-panel.visible { display: block; }

/* Loader */
.loader { 
    border: 3px solid rgba(255,255,255,0.3); 
    border-top: 3px solid white; 
    border-radius: 50%; 
    width: 24px; 
    height: 24px; 
    animation: spin 0.8s linear infinite; 
    display: none; 
}
@keyframes spin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
}

/* Layout */
header, main { width: 100%; max-width: 600px; text-align:center; }
#list-attempts { max-height: 300px; overflow-y: auto; display:flex; flex-direction:column-reverse; gap:4px; }

/* Pulsante indizio */
#btn-hint { border-radius:999px; padding:8px 16px; background:white; border:1px solid var(--outlineColor); cursor:pointer; font-weight:bold; font-size:0.75rem; }

/* Input box centrato */
#input-container { width: 100%; max-width: 600px; display:flex; gap:12px; margin-top:32px; }

/* Pannello statistiche */
#stats-btn, #music-btn { position: fixed; bottom:24px; width:48px; height:48px; border-radius:50%; background:var(--primaryColor); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:60; }
/* Li avviciniamo entrambi al centro */
#stats-btn { right:72px; } 
#music-btn { left:72px; }
#stats-panel { position: fixed; bottom:0; left:0; right:0; max-width:600px; margin:auto; background:white; border-radius:2rem 2rem 0 0; padding:24px; transform:translateY(100%); transition: transform 0.3s; z-index:55; }

/* Player YouTube */
#music-panel { position:fixed; bottom:-110%; left:50%; transform:translateX(-50%); width:100%; max-width:600px; background:white; border-radius:2rem 2rem 0 0; padding:24px; transition:0.3s; z-index:50; }
</style>
</head>

<body>

<header class="mt-6 mb-6 w-full max-w-md">
    <h1 id="wave-title" class="wave-text text-6xl font-bold text-slate-800 mb-2"></h1>
    <p class="opacity-60 text-sm">Alimentato da Puter.js con Gemini</p>
    <div class="flex justify-center mt-4">
        <button id="btn-hint">ðŸ’¡ INDIZIO</button>
    </div>
</header>

<main class="w-full max-w-md flex flex-col items-center">
    <div id="ai-box" class="ai-panel mb-6 border">
        <div class="flex items-center gap-2 mb-2">
            <span>âœ¨</span>
            <span id="ai-label" class="text-xs font-bold uppercase tracking-wider text-slate-500">
                Assistente AI
            </span>
        </div>
        <p id="ai-text" class="text-sm italic text-slate-700"></p>
    </div>

    <div id="list-attempts"></div>

    <div id="empty-msg" class="py-24 text-center opacity-30 w-full">
        <p class="text-xl">Digita una parola</p>
    </div>

    <!-- Barra input centrata -->
    <div id="input-container">
        <input type="text" id="input-word" placeholder="Prova una parola..." class="input-rounded">
        <button id="btn-send" class="btn-main">
            <div class="loader" id="spin-loader"></div>
            <span id="icon-send">âž”</span>
        </button>
    </div>
</main>

<!-- Bottone e pannello statistiche -->
<div id="stats-btn">ðŸ“Š</div>
<div id="stats-panel">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-slate-800">Statistiche Personali</h2>
        <button onclick="toggleStatsPanel()" class="text-slate-400 font-bold text-xl">âœ•</button>
    </div>
    <div class="flex flex-col gap-2 text-slate-700">
        <p><strong>Partita corrente:</strong> <span id="stat-current-attempts">0</span> tentativi</p>
        <p><strong>Vittorie totali:</strong> <span id="stat-total-wins">0</span></p>
        <p><strong>Miglior partita:</strong> <span id="stat-best-attempts">â€“</span> tentativi</p>
    </div>
</div>

<!-- Player YouTube -->
<div id="music-btn">ðŸŽµ</div>
<div id="music-panel">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">Music Player</h3>
        <button onclick="closeMusicPanel()" class="text-gray-500 font-bold text-xl">âœ•</button>
    </div>
    <div class="flex gap-2 mb-4">
        <input type="text" id="yt-url" placeholder="Incolla link YouTube..." class="input-rounded flex-1">
        <button onclick="loadVideo()" class="btn-main">CARICA</button>
    </div>
    <div class="aspect-video w-full bg-black rounded-xl overflow-hidden">
        <div id="player"></div>
    </div>
</div>

<script>
/* --- Animazione titolo snake wave --- */
const titolo = "Contesto AI";
const waveTitle = document.getElementById("wave-title");
titolo.split("").forEach((c,i)=>{
    const s = document.createElement("span");
    s.innerText = c;
    s.style.animationDelay = `${i*0.08}s`;
    waveTitle.appendChild(s);
});

/* --- Variabili gioco --- */
let paroleSegrete = [];
let parolaDaIndovinare = "";
let partitaInCorso = false;
let storicoTentativi = [];
let livelloIndizio = 0;
let ultimoIndizio = 0;

/* --- Statistiche locali --- */
const LOCAL_STATS_KEY = "contestoAI_stats";
let stats = { totalWins:0, bestAttempts:null };
function loadStats(){const s=localStorage.getItem(LOCAL_STATS_KEY); if(s) stats=JSON.parse(s); updateStatsUI();}
function saveStats(){localStorage.setItem(LOCAL_STATS_KEY, JSON.stringify(stats));}
function updateStatsUI(){
    document.getElementById("stat-total-wins").innerText=stats.totalWins;
    document.getElementById("stat-best-attempts").innerText=stats.bestAttempts!==null?stats.bestAttempts:"â€“";
    document.getElementById("stat-current-attempts").innerText=storicoTentativi.length;
}
function recordWin(){stats.totalWins++; if(stats.bestAttempts===null || storicoTentativi.length<stats.bestAttempts) stats.bestAttempts=storicoTentativi.length; saveStats(); updateStatsUI();}
function toggleStatsPanel(){
    const p=document.getElementById("stats-panel");
    const isOpen = p.style.transform === "translateY(0%)";
    p.style.transform = isOpen ? "translateY(100%)" : "translateY(0%)";
}

/* --- Player musicale YouTube --- */
var player;
function onYouTubeIframeAPIReady(){
    player=new YT.Player('player',{height:'100%',width:'100%',videoId:'n61ULEU7CO0',playerVars:{'autoplay':0,'controls':1,'modestbranding':1,'rel':0}});
}
var tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
function openMusicPanel(){document.getElementById('music-panel').style.bottom="0";}
function closeMusicPanel(){document.getElementById('music-panel').style.bottom="-110%";}
function loadVideo(){let input=document.getElementById('yt-url').value; const regExp=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match=input.match(regExp); if(match&&match[2].length==11)player.loadVideoById(match[2]);}

/* --- UI --- */
const ui = {
    input: document.getElementById("input-word"),
    sendBtn: document.getElementById("btn-send"),
    loader: document.getElementById("spin-loader"),
    icon: document.getElementById("icon-send"),
    list: document.getElementById("list-attempts"),
    empty: document.getElementById("empty-msg"),
    aiBox: document.getElementById("ai-box"),
    aiText: document.getElementById("ai-text"),
    aiLabel: document.getElementById("ai-label"),
    hintBtn: document.getElementById("btn-hint"),
    statsBtn: document.getElementById("stats-btn"),
    musicBtn: document.getElementById("music-btn")
};

/* --- Caricamento parole da file esterno --- 
l'unica cosa che ho effettivamente 
diviso dal resto perchÃ© stranamente non ha rotto nulla XD*/
async function caricaParole(){
    try{ const res = await fetch("parole.json"); paroleSegrete = await res.json(); }
    catch{ paroleSegrete = ["viaggio","montagna","computer","amicizia","espresso","oceano","stella","giardino","isola","foresta","pizza","libro"]; }
}

/* --- Nuova partita --- */
function avviaNuovaPartita(){
    if(!paroleSegrete.length) return;
    parolaDaIndovinare = paroleSegrete[Math.floor(Math.random()*paroleSegrete.length)];
    partitaInCorso = true;
    storicoTentativi = [];
    livelloIndizio = 0;
    ui.list.innerHTML = "";
    ui.aiBox.classList.remove("visible");
    ui.empty.style.display = "flex";
    ui.input.value = "";
    console.log("Nuova parola scelta:", parolaDaIndovinare);
    updateStatsUI();
}

/* --- AI Chat --- */
async function aiChat(prompt){await puter.ready; const res=await puter.ai.chat({prompt,model:"gemini-pro"}); return res.message.content;}

/* --- Distanza AI --- */
async function calcolaDistanzaAI(parolaUtente){
    if(parolaUtente === parolaDaIndovinare) return 1;
    try{
        const testo = await aiChat(`Calcola la distanza semantica tra "${parolaUtente}" e "${parolaDaIndovinare}". Rispondi solo con un numero tra 2 e 15000.`);
        const num = parseInt(testo.replace(/\D/g,""));
        if(isNaN(num)) throw "NaN";
        ui.aiLabel.innerText = "Assistente AI (Cloud)";
        return num;
    } catch{
        ui.aiLabel.innerText = "Assistente (Offline)";
        return Math.abs(parolaUtente.length - parolaDaIndovinare.length)*500 + 2000;
    }
}

/* --- Feedback --- */
function feedbackTestuale(d){
    if(d===1) return "ðŸ† Vittoria";
    if(d<800) return "ðŸ”¥ Bollente";
    if(d<3000) return "ðŸ™‚ Vicino";
    if(d<7000) return "ðŸ˜ Lontano";
    return "ðŸ§Š Ghiacciato";
}

/* --- Gestione invio --- */
async function gestisciInvio(){
    const parola = ui.input.value.trim().toLowerCase();
    if(!parola || !partitaInCorso) return;
    ui.loader.style.display="block"; ui.icon.style.display="none";
    const distanza = await calcolaDistanzaAI(parola);
    ui.loader.style.display="none"; ui.icon.style.display="block"; ui.input.value="";
    ui.empty.style.display="none";
    storicoTentativi.push({parola,distanza});
    aggiungiRiga(parola,distanza);
    ui.aiBox.classList.add("visible"); ui.aiText.innerText = feedbackTestuale(distanza);
    updateStatsUI();
    if(distanza===1){ finePartita(); }
}

/* --- Aggiungi riga --- */
function aggiungiRiga(parola,distanza){
    const percentuale = Math.max(5, 100-(distanza/15000*100));
    let colore = distanza===1?"#22c55e":distanza<1000?"#4ade80":"#facc15";
    const div=document.createElement("div");
    div.className="guess-row shadow-sm";
    div.innerHTML=`<div class="progress-bg" style="width:${percentuale}%;background:${colore};opacity:.3"></div>
                   <div class="content-z font-bold"><span>${parola}</span><span>${feedbackTestuale(distanza)}</span></div>`;
    ui.list.appendChild(div);
}

/* --- Fine partita --- */
function finePartita(){
    partitaInCorso=false;
    ui.aiText.innerText="Grande! Hai trovato la parola: "+parolaDaIndovinare;
    ui.aiBox.classList.add("visible");
    recordWin();
}

/* --- Indizi progressivi --- */
ui.hintBtn.onclick = async function(){
    const now=Date.now();
    if(now-ultimoIndizio<10000){
        ui.aiText.innerText="Aspetta qualche secondo prima del prossimo indizio â³";
        ui.aiBox.classList.add("visible");
        return;
    }
    ultimoIndizio=now; livelloIndizio++;
    ui.aiBox.classList.add("visible");
    if(livelloIndizio===1) ui.aiText.innerText = "La parola ha "+parolaDaIndovinare.length+" lettere.";
    else if(livelloIndizio===2) ui.aiText.innerText = "Inizia con la lettera: "+parolaDaIndovinare[0].toUpperCase();
    else {
        try{ ui.aiText.innerText = await aiChat(`Dai un indizio concettuale sulla parola "${parolaDaIndovinare}" senza dirla.`); }
        catch{ ui.aiText.innerText = "Indizio AI non disponibile."; }
    }
};

/* --- Eventi --- */
ui.sendBtn.onclick = gestisciInvio;
ui.input.addEventListener("keydown", e=>e.key==="Enter"&&gestisciInvio());
ui.statsBtn.onclick = toggleStatsPanel;
ui.musicBtn.onclick = openMusicPanel;

/*
